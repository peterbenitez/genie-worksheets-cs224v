"""
Persona Generator for Automated Conversation Testing

Generates diverse investor personas for testing the investment agent.
Supports both simple random generation and LLM-based generation.
"""

import random
import json
import os
from pathlib import Path
from typing import Optional, Dict
from dotenv import load_dotenv
from openai import AzureOpenAI
from investor_profiles import InvestorProfile


def generate_simple_persona(seed: Optional[int] = None) -> InvestorProfile:
    """
    Generate a random investor persona without LLM calls.

    This creates variation by randomly selecting attributes from predefined
    ranges and options, then combining them into a coherent profile.

    Args:
        seed: Optional random seed for reproducibility

    Returns:
        InvestorProfile with randomized but coherent attributes
    """
    if seed is not None:
        random.seed(seed)

    # Random age selection
    age = random.randint(25, 70)

    # Risk tolerance options
    risk_tolerances = ["conservative", "moderate", "aggressive"]
    risk_tolerance = random.choice(risk_tolerances)

    # Experience levels
    experience_levels = ["novice", "intermediate", "expert"]
    experience_level = random.choice(experience_levels)

    # Capital based on age and risk (some correlation)
    if age < 35:
        capital_range = (10000, 100000)
    elif age < 50:
        capital_range = (50000, 300000)
    else:
        capital_range = (100000, 500000)

    initial_capital = random.randint(capital_range[0], capital_range[1])

    # Time horizon correlated with age
    if age < 40:
        time_horizon = "long-term (20+ years)"
    elif age < 55:
        time_horizon = "medium-term (10-20 years)"
    else:
        time_horizon = "short-term (5-10 years)"

    # Investment goal based on age and risk
    goals = [
        "wealth accumulation",
        "retirement planning",
        "capital preservation",
        "income generation",
        "saving for major purchase"
    ]

    if age < 40 and risk_tolerance == "aggressive":
        investment_goal = "wealth accumulation"
    elif age > 55:
        investment_goal = random.choice(["retirement planning", "capital preservation"])
    else:
        investment_goal = random.choice(goals)

    # Personality traits - mix from existing profiles
    personality_templates = [
        "demanding and confident, asks direct questions and expects specific answers",
        "cautious and anxious, seeks reassurance and prefers conservative options",
        "confused and seeking basic information, asks many clarifying questions",
        "skeptical and analytical, challenges recommendations and asks for evidence",
        "pushy and persistent, asks leading questions to get desired answers"
    ]

    personality = random.choice(personality_templates)

    # Generate unique name for tracking
    persona_name = f"generated_persona_{seed if seed else random.randint(1000, 9999)}"

    return InvestorProfile(
        age=age,
        risk_tolerance=risk_tolerance,
        investment_goal=investment_goal,
        experience_level=experience_level,
        personality=personality,
        initial_capital=initial_capital,
        time_horizon=time_horizon
    )


def generate_llm_persona(
    client: AzureOpenAI,
    diversity_params: Optional[Dict] = None,
    seed: Optional[int] = None
) -> InvestorProfile:
    """
    Generate investor persona using LLM (Azure OpenAI).

    Creates realistic, coherent personas with diverse characteristics
    that are internally consistent (e.g., young aggressive investors
    have longer time horizons).

    Args:
        client: Azure OpenAI client instance
        diversity_params: Optional constraints (age_range, risk_preference, etc.)
        seed: Optional seed for reproducibility (affects LLM sampling)

    Returns:
        InvestorProfile generated by LLM
    """
    # Build diversity constraints
    constraints = ""
    if diversity_params:
        if "age_range" in diversity_params:
            constraints += f"\n- Age between {diversity_params['age_range'][0]} and {diversity_params['age_range'][1]}"
        if "risk_preference" in diversity_params:
            constraints += f"\n- Risk tolerance: {diversity_params['risk_preference']}"
        if "experience" in diversity_params:
            constraints += f"\n- Experience level: {diversity_params['experience']}"

    # LLM prompt for persona generation
    prompt = f"""Generate a realistic investor persona for testing a financial advisory AI system.

The persona should be internally consistent and realistic. For example:
- Young aggressive investors should have longer time horizons (15-30 years)
- Older conservative investors should focus on capital preservation or income
- Experience level should match investment goals (novices ask basic questions)
- Capital amounts should be realistic for the age and goals

{constraints if constraints else "Create a diverse persona with varied characteristics."}

Return ONLY a JSON object with this exact structure (no other text):
{{
    "age": <number between 25-70>,
    "risk_tolerance": "<conservative|moderate|aggressive>",
    "investment_goal": "<specific goal like 'retirement planning', 'wealth accumulation', etc>",
    "experience_level": "<novice|intermediate|expert>",
    "personality": "<2-3 sentence description of communication style and behavior>",
    "initial_capital": <number between 10000-1000000>,
    "time_horizon": "<short-term (5-10 years)|medium-term (10-20 years)|long-term (20+ years)>"
}}

Personality examples:
- "Demanding and data-driven, expects detailed analysis with specific numbers and sources"
- "Cautious and risk-averse, frequently asks about worst-case scenarios and safety"
- "Enthusiastic but inexperienced, asks basic questions and seeks educational guidance"

Ensure the personality description is professional and avoids aggressive or accusatory language.
{f'Use seed {seed} to influence variety.' if seed else ''}"""

    try:
        # Call Azure OpenAI
        response = client.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": "You are a persona generator for financial AI testing. Generate realistic, diverse investor personas."},
                {"role": "user", "content": prompt}
            ],
            temperature=0.9,  # High temperature for diversity
            max_tokens=500,
            seed=seed  # Use seed for reproducibility if provided
        )

        # Parse response
        response_text = response.choices[0].message.content.strip()

        # Remove markdown code blocks if present
        if response_text.startswith("```"):
            response_text = response_text.split("```")[1]
            if response_text.startswith("json"):
                response_text = response_text[4:]
            response_text = response_text.strip()

        persona_data = json.loads(response_text)

        # Create InvestorProfile
        return InvestorProfile(
            age=persona_data["age"],
            risk_tolerance=persona_data["risk_tolerance"],
            investment_goal=persona_data["investment_goal"],
            experience_level=persona_data["experience_level"],
            personality=persona_data["personality"],
            initial_capital=persona_data["initial_capital"],
            time_horizon=persona_data["time_horizon"]
        )

    except Exception as e:
        # Fallback to simple generation if LLM fails
        print(f"Warning: LLM persona generation failed ({e}), using simple generation")
        return generate_simple_persona(seed=seed)


# Test function for validation
def test_generation():
    """Test persona generation with various seeds."""
    print("Testing Simple Persona Generation\n" + "="*50)

    for i in range(3):
        persona = generate_simple_persona(seed=i)
        print(f"\nPersona {i+1}:")
        print(f"  Age: {persona.age}")
        print(f"  Risk: {persona.risk_tolerance}")
        print(f"  Experience: {persona.experience_level}")
        print(f"  Capital: ${persona.initial_capital:,}")
        print(f"  Goal: {persona.investment_goal}")
        print(f"  Horizon: {persona.time_horizon}")
        print(f"  Personality: {persona.personality[:60]}...")


def test_llm_generation():
    """Test LLM-based persona generation."""
    # Load environment variables from project root
    env_path = Path(__file__).parent.parent.parent.parent.parent / ".env"
    load_dotenv(env_path)

    # Initialize Azure OpenAI client
    client = AzureOpenAI(
        azure_endpoint=os.environ["LLM_API_ENDPOINT"],
        api_key=os.environ["LLM_API_KEY"],
        api_version=os.environ.get("LLM_API_VERSION", "2025-01-01-preview")
    )

    print("Testing LLM Persona Generation\n" + "="*50)

    # Test with different diversity params
    test_configs = [
        {"seed": 100, "params": None},
        {"seed": 101, "params": {"age_range": (25, 35), "risk_preference": "aggressive"}},
        {"seed": 102, "params": {"age_range": (55, 70), "risk_preference": "conservative"}},
    ]

    for i, config in enumerate(test_configs):
        print(f"\nTest {i+1}: {config['params']}")
        persona = generate_llm_persona(client, diversity_params=config["params"], seed=config["seed"])

        print(f"  Age: {persona.age}")
        print(f"  Risk: {persona.risk_tolerance}")
        print(f"  Experience: {persona.experience_level}")
        print(f"  Capital: ${persona.initial_capital:,}")
        print(f"  Goal: {persona.investment_goal}")
        print(f"  Horizon: {persona.time_horizon}")
        print(f"  Personality: {persona.personality}")


if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == "--llm":
        test_llm_generation()
    else:
        test_generation()
